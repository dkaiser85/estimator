<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputLaborCost = document.getElementById('totalLaborCost');
        const inputEngagement = document.getElementById('employeeEngagement');
        const inputTurnover = document.getElementById('turnoverPercentage');

        const engagementFill = document.getElementById('engagementFill');
        const engagementText = document.getElementById('engagementText');

        const returnOnLaborFill = document.getElementById('returnOnLaborFill');
        const returnOnLaborText = document.getElementById('returnOnLaborText');

        const lostLaborCostEl = document.getElementById('lostLaborCost');
        const onePercentChangeEl = document.getElementById('onePercentChange');
        const totalAnnualizedLossesEl = document.getElementById('totalAnnualizedLosses');

        const generateReportButton = document.getElementById('generateReportButton');

        // Modal elements
        const reportModal = document.getElementById('reportModal');
        const closeButton = document.querySelector('.close-button');
        const reportContent = document.getElementById('reportContent');

        // Initialize gauges and displays
        calculateMetrics();

        // Add event listeners
        inputLaborCost.addEventListener('input', function(e) {
            // Remove non-digit characters except decimal point
            const value = e.target.value.replace(/,/g, '').replace(/[^0-9.]/g, '');
            // Format with commas
            e.target.value = formatNumberWithCommas(value);
            calculateMetrics();
        });

        inputEngagement.addEventListener('input', function() {
            calculateMetrics();
        });

        inputTurnover.addEventListener('input', function() {
            calculateMetrics();
        });

        function formatNumberWithCommas(number) {
            if (!number) return '';
            const parts = number.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join(".");
        }

        function updateGauge(fillElement, percentage, color) {
            // Ensure percentage does not exceed 100%
            const cappedPercentage = Math.min(Math.max(percentage, 0), 100);
            const dashArray = 367.566; // For radius 78
            const dashOffset = dashArray - (cappedPercentage / 100) * dashArray;

            fillElement.style.strokeDasharray = dashArray;
            fillElement.style.strokeDashoffset = dashOffset;
            fillElement.style.stroke = color;
        }

        function calculateMetrics() {
            // Parse the labor cost input by removing commas
            const laborCost = parseFloat(inputLaborCost.value.replace(/,/g, ''));
            const engagementPercentage = parseFloat(inputEngagement.value);
            const turnoverPercentage = parseFloat(inputTurnover.value);

            // Constants
            const averageSalary = 60000; // Assumed average salary
            const costToReplaceOneEmployee = 9861; // Given average replacement cost

            if (
                isNaN(laborCost) || laborCost <= 0 ||
                isNaN(engagementPercentage) || engagementPercentage < 0 || engagementPercentage > 100 ||
                isNaN(turnoverPercentage) || turnoverPercentage < 0 || turnoverPercentage > 100
            ) {
                resetGauges();
                return;
            }

            /*** Update Overall Engagement Gauge ***/
            let engagementColor = '';

            if (engagementPercentage <= 45) {
                engagementColor = '#ED5C5C'; // Red
            } else if (engagementPercentage <= 70) {
                engagementColor = '#E1D687'; // Yellow
            } else {
                engagementColor = '#75BB7D'; // Green
            }

            updateGauge(engagementFill, engagementPercentage, engagementColor);
            engagementText.textContent = Math.round(engagementPercentage) + '%'; // Rounded

            /*** Calculate Return-On-Labor® ***/
            const engagementFactor = (0.46 * (engagementPercentage / 100)) + 0.54;
            const returnOnLabor = engagementFactor * laborCost;
            const returnOnLaborPercentage = Math.round( (returnOnLabor / laborCost) * 100 ); // Rounded

            let returnOnLaborColor = '';

            if (returnOnLaborPercentage <= 45) {
                returnOnLaborColor = '#ED5C5C'; // Red
            } else if (returnOnLaborPercentage <= 70) {
                returnOnLaborColor = '#E1D687'; // Yellow
            } else {
                returnOnLaborColor = '#75BB7D'; // Green
            }

            updateGauge(returnOnLaborFill, returnOnLaborPercentage, returnOnLaborColor);
            returnOnLaborText.textContent = Math.round(returnOnLaborPercentage) + '%'; // Rounded

            /*** Update Financial Metrics ***/
            const lostLaborCost = laborCost - returnOnLabor;
            const formattedLostLaborCost = `-$${Math.round(lostLaborCost).toLocaleString('en-US')}`; // Rounded
            lostLaborCostEl.textContent = formattedLostLaborCost;

            const onePercentChange = Math.round(0.0046 * laborCost); // Rounded
            const formattedOnePercentChange = `$${onePercentChange.toLocaleString('en-US')}`;
            onePercentChangeEl.textContent = formattedOnePercentChange;

            /*** Calculate Projected Turnover Costs ***/
            // Estimate headcount
            const estimatedHeadcount = laborCost / averageSalary;

            // Convert turnover percentage to decimal
            const turnoverDecimal = turnoverPercentage / 100;

            // Projected Turnover Costs
            const projectedTurnoverCosts = estimatedHeadcount * turnoverDecimal * costToReplaceOneEmployee;

            /*** Calculate Total Annualized Losses ***/
            const totalAnnualizedLosses = lostLaborCost + projectedTurnoverCosts;
            const formattedTotalAnnualizedLosses = `-$${Math.round(totalAnnualizedLosses).toLocaleString('en-US')}`; // Rounded
            totalAnnualizedLossesEl.textContent = formattedTotalAnnualizedLosses;
        }

        function resetGauges() {
            // Reset Overall Engagement gauge to 0%
            updateGauge(engagementFill, 0, '#ED5C5C');
            engagementText.textContent = '0%';

            // Reset Return-On-Labor® gauge to 0%
            updateGauge(returnOnLaborFill, 0, '#E1D687');
            returnOnLaborText.textContent = '0%';

            // Reset financial metrics to '--'
            lostLaborCostEl.textContent = '--';
            onePercentChangeEl.textContent = '--';
            totalAnnualizedLossesEl.textContent = '--';
        }

        // Generate Report Button Click Event
        generateReportButton.addEventListener('click', function() {
            // Get current inputs
            const laborCost = parseFloat(inputLaborCost.value.replace(/,/g, ''));
            const engagementPercentage = parseFloat(inputEngagement.value);
            const turnoverPercentage = parseFloat(inputTurnover.value);

            // Validate inputs
            if (
                isNaN(laborCost) || laborCost <= 0 ||
                isNaN(engagementPercentage) || engagementPercentage < 0 || engagementPercentage > 100 ||
                isNaN(turnoverPercentage) || turnoverPercentage < 0 || turnoverPercentage > 100
            ) {
                alert("Please enter valid input values.");
                return;
            }

            // Calculate current metrics
            const currentEngagementFactor = (0.46 * (engagementPercentage / 100)) + 0.54;
            const currentReturnOnLabor = currentEngagementFactor * laborCost;
            const currentAnnualizedLostLabor = Math.round(laborCost - currentReturnOnLabor); // Rounded

            // Calculate projected metrics with 10% higher engagement
            const projectedEngagement = Math.min(engagementPercentage + 10, 100); // Cap at 100%
            const projectedEngagementFactor = (0.46 * (projectedEngagement / 100)) + 0.54;
            const projectedReturnOnLabor = projectedEngagementFactor * laborCost;
            const projectedAnnualizedLostLabor = Math.round(laborCost - projectedReturnOnLabor); // Rounded

            const additionalProfit = Math.round(currentAnnualizedLostLabor - projectedAnnualizedLostLabor); // Rounded

            // Calculate investment and net gain
            const investment = Math.round(additionalProfit / 3); // 1/3 of total additional profit
            const netGain = additionalProfit; // As per user's example

            // Format numbers with commas and no decimal places
            function formatCurrency(num) {
                return num.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }

            // Calculate stroke-dashoffset for gauges
            const currentEngagementDashOffset = 367.566 - (Math.round(engagementPercentage) / 100) * 367.566;
            const currentReturnOnLaborDashOffset = 367.566 - (Math.round( (currentReturnOnLabor / laborCost) * 100 )) * 367.566 / 100;

            const projectedEngagementDashOffset = 367.566 - (Math.round(projectedEngagement) / 100) * 367.566;
            const projectedReturnOnLaborDashOffset = 367.566 - (Math.round( (projectedReturnOnLabor / laborCost) * 100 )) * 367.566 / 100;

            // Determine colors based on specified ranges
            function getColor(percentage) {
                if (percentage <= 45) {
                    return '#ED5C5C'; // Red
                } else if (percentage <= 70) {
                    return '#E1D687'; // Yellow
                } else {
                    return '#75BB7D'; // Green
                }
            }

            // Generate report content based on supplied text
            const reportHTML = `
                <div class="logo">
                    <img src="https://static.showit.co/file/UwdjWfwfRQ-XzVtd8ECO4g/176740/cmri_blue_for_dk.png" alt="The Culture MRI® Logo">
                </div>
                <hr class="horizontal-line">
                <h2>Projected Financial Impact For Your Company</h2>
                <p>These recommendations are designed to provide a lift within the culture of your company by addressing the reported appetite for stronger vision. While these action steps are only described briefly here, we look forward to discussing each detail with your team and providing additional guidance as needed.</p>
                <p>Based on the rather conservative plan described in this report, your company can improve its Employee Value Proposition, better providing workers what they need to thrive and perform. This improvement requires no additional spending on salaries but maximizes the return on your current labor costs. The result will be higher productivity and profitability. Best of all, the impact will be measurable, not only in assessment scores, but also in financial results.</p>
                
                <!-- Before Section Header -->
                <h3 class="blue-header">Before:</h3>
                
                <p>Currently, you’re investing ${formatCurrency(laborCost)} annually in labor, but with a ${Math.round(engagementPercentage)}% engagement level, you’re losing ${formatCurrency(currentAnnualizedLostLabor)} in productivity each year. This is a significant hidden cost impacting your bottom line.</p>
                
                <!-- Insert Current Engagement Gauge, Return-On-Labor® Gauge, and Annualized Lost Labor in 3 Columns -->
                <div class="results-section">
                    <div class="result-item">
                        <h3>Overall Engagement</h3>
                        <div class="gauge">
                            <svg width="150" height="150" viewBox="0 0 195 195">
                                <!-- Background Arc -->
                                <path class="gauge__background" d="M39 162.5 A78 78 0 1 1 156 162.5" />
                                <!-- Fill Arc -->
                                <path class="gauge__fill" d="M39 162.5 A78 78 0 1 1 156 162.5"
                                      stroke="${getColor(Math.round(engagementPercentage))}" stroke-dasharray="367.566" stroke-dashoffset="${currentEngagementDashOffset}" />
                                <!-- Percentage Text -->
                                <text x="97.5" y="115" text-anchor="middle" font-size="24px" font-weight="700"
                                      fill="#173248">${Math.round(engagementPercentage)}%</text>
                            </svg>
                        </div>
                    </div>
                    <div class="result-item">
                        <h3>Return-On-Labor®</h3>
                        <div class="gauge">
                            <svg width="150" height="150" viewBox="0 0 195 195">
                                <!-- Background Arc -->
                                <path class="gauge__background" d="M39 162.5 A78 78 0 1 1 156 162.5" />
                                <!-- Fill Arc -->
                                <path class="gauge__fill" d="M39 162.5 A78 78 0 1 1 156 162.5"
                                      stroke="${getColor(Math.round( (currentReturnOnLabor / laborCost) * 100 ))}" stroke-dasharray="367.566" stroke-dashoffset="${currentReturnOnLaborDashOffset}" />
                                <!-- Percentage Text -->
                                <text x="97.5" y="115" text-anchor="middle" font-size="24px" font-weight="700"
                                      fill="#173248">${Math.round( (currentReturnOnLabor / laborCost) * 100 )}%</text>
                            </svg>
                        </div>
                    </div>
                    <div class="result-item annualized-lost-labor">
                        <h3>Annualized Lost Labor</h3>
                        <p class="red">${formatCurrency(currentAnnualizedLostLabor)}</p>
                    </div>
                </div>
                
                <!-- After Section Header -->
                <h3 class="blue-header">After:</h3>
                
                <p>By implementing targeted strategies and The Culture MRI® recommendations to elevate employee engagement to ${projectedEngagement}%, you will recover ${formatCurrency(additionalProfit)} annually from your existing labor investment.</p>
                
                <!-- Insert Projected Engagement Gauge, Return-On-Labor® Gauge, and Annualized Lost Labor in 3 Columns -->
                <div class="results-section">
                    <div class="result-item">
                        <h3>Overall Engagement</h3>
                        <div class="gauge">
                            <svg width="150" height="150" viewBox="0 0 195 195">
                                <!-- Background Arc -->
                                <path class="gauge__background" d="M39 162.5 A78 78 0 1 1 156 162.5" />
                                <!-- Fill Arc -->
                                <path class="gauge__fill" d="M39 162.5 A78 78 0 1 1 156 162.5"
                                      stroke="${getColor(Math.round(projectedEngagement))}" stroke-dasharray="367.566" stroke-dashoffset="${projectedEngagementDashOffset}" />
                                <!-- Percentage Text -->
                                <text x="97.5" y="115" text-anchor="middle" font-size="24px" font-weight="700"
                                      fill="#173248">${projectedEngagement}%</text>
                            </svg>
                        </div>
                    </div>
                    <div class="result-item">
                        <h3>Return-On-Labor®</h3>
                        <div class="gauge">
                            <svg width="150" height="150" viewBox="0 0 195 195">
                                <!-- Background Arc -->
                                <path class="gauge__background" d="M39 162.5 A78 78 0 1 1 156 162.5" />
                                <!-- Fill Arc -->
                                <path class="gauge__fill" d="M39 162.5 A78 78 0 1 1 156 162.5"
                                      stroke="${getColor(Math.round( (projectedReturnOnLabor / laborCost) * 100 ))}" stroke-dasharray="367.566" stroke-dashoffset="${projectedReturnOnLaborDashOffset}" />
                                <!-- Percentage Text -->
                                <text x="97.5" y="115" text-anchor="middle" font-size="24px" font-weight="700"
                                      fill="#173248">${Math.round( (projectedReturnOnLabor / laborCost) * 100 )}%</text>
                            </svg>
                        </div>
                    </div>
                    <div class="result-item annualized-lost-labor">
                        <h3>Annualized Lost Labor</h3>
                        <p class="red">${formatCurrency(projectedAnnualizedLostLabor)}</p>
                    </div>
                </div>
                
                <!-- Conclusion Section Header -->
                <h3 class="blue-header">Conclusion:</h3>
                
                <!-- Dynamic Paragraph Below Conclusion -->
                <div class="dynamic-paragraph">
                    <p>The investment in these engagement initiatives is vastly outweighed by the financial gains. For instance, allocating ${formatCurrency(investment)} to our recommendations will generate a net gain of ${formatCurrency(netGain)} in the first year alone.</p>
                </div>
                
                <!-- Total Additional Profit (Annual): -->
                <div class="financial-metrics-center">
                    <h3 class="total-additional-profit">TOTAL ADDITIONAL PROFIT (ANNUAL):</h3>
                    <p class="black">${formatCurrency(additionalProfit)}</p>
                </div>
                
                <!-- Download PDF Button -->
                <button class="download-pdf-button no-pdf" id="downloadPDFButton">Download Sample Analysis Report</button>
            `;

            // Inject report content into the modal
            reportContent.innerHTML = reportHTML;

            // Display the modal
            reportModal.style.display = 'block';

            // Add event listener for Download PDF button
            const downloadPDFButton = document.getElementById('downloadPDFButton');
            if (downloadPDFButton) {
                downloadPDFButton.addEventListener('click', function() {
                    // Hide elements with class 'no-pdf'
                    document.querySelectorAll('.no-pdf').forEach(function(element) {
                        element.style.display = 'none';
                    });

                    // Use html2canvas to capture the reportContent
                    html2canvas(reportContent, { scale: 3 }).then(canvas => { // Increased scale for better quality
                        const imgData = canvas.toDataURL('image/png');

                        // **Define Margins and Page Dimensions**
                        const marginLeft = 18; // 0.25in *72pt/in = 18pt
                        const marginTop = 18;  // 0.25in
                        const marginRight = 18; // 0.25in
                        const marginBottom = 36; // 0.5in

                        const pageWidth = 612; // 8.5in *72pt/in =612pt
                        const pageHeight = 792; //11in *72pt/in =792pt

                        const contentWidth = pageWidth - marginLeft - marginRight; //576pt
                        const contentHeight = pageHeight - marginTop - marginBottom; //738pt

                        // **Instantiate jsPDF with 'letter' format**
                        const pdf = new window.jspdf.jsPDF({
                            orientation: 'portrait',
                            unit: 'pt',
                            format: 'letter' // Changed from 'a4' to 'letter' for 8.5x11 inches
                        });

                        // **Calculate Image Dimensions to Fit Within Margins**
                        const imgWidth = canvas.width;
                        const imgHeight = canvas.height;

                        // Calculate the scaling factor to fit the image within the content area
                        const scaleFactor = Math.min(contentWidth / imgWidth, contentHeight / imgHeight);

                        // Calculate the scaled width and height
                        const scaledWidth = imgWidth * scaleFactor;
                        const scaledHeight = imgHeight * scaleFactor;

                        // Calculate the position to center the image within the content area
                        const x = marginLeft + (contentWidth - scaledWidth) / 2;
                        const y = marginTop + (contentHeight - scaledHeight) / 2;

                        // **Add the Image to PDF with Calculated Dimensions and Position**
                        pdf.addImage(imgData, 'PNG', x, y, scaledWidth, scaledHeight);

                        /*** Add Watermark ***/
                        // Set font properties for watermark
                        pdf.setFontSize(60);
                        pdf.setTextColor(200, 200, 200); // Light gray color

                        // Calculate the center of the page
                        const centerX = pageWidth / 2;
                        const centerY = pageHeight / 2;

                        // Add rotated watermark text
                        pdf.text('SAMPLE ANALYSIS', centerX, centerY, {
                            align: 'center',
                            angle: -45 // Rotate text by -45 degrees
                        });

                        // **Save the PDF**
                        pdf.save('Projected_Financial_Impact_Report.pdf');

                        // Show elements again
                        document.querySelectorAll('.no-pdf').forEach(function(element) {
                            element.style.display = '';
                        });

                        // Hide the Download Button after download
                        downloadPDFButton.style.display = 'none';
                    }).catch(err => {
                        console.error('Failed to generate PDF:', err);
                        alert('An error occurred while generating the PDF. Please try again.');
                    });
                });
            }
        });

        // Close Modal When 'x' is Clicked
        closeButton.addEventListener('click', function() {
            reportModal.style.display = 'none';
        });

        // Close Modal When Clicking Outside the Modal Content
        window.addEventListener('click', function(event) {
            if (event.target == reportModal) {
                reportModal.style.display = 'none';
            }
        });
    });
</script>
